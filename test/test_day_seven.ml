open! Core
open! Hardcaml
open! Hardcaml_waveterm
module Day_seven = Advent_of_fpga_2025.Day_seven
module Sim = Cyclesim.With_interface (Day_seven.I) (Day_seven.O)

let test_input
  ~(here : [%call_pos])
  ?(create_vcd = false)
  ?(display_width = 90)
  ?(print_waveform = true)
  ?(cycles_per_baud = 4)
  ?(pan_to_end = false)
  input_str
  =
  let scope = Scope.create ~auto_label_hierarchical_ports:true ~flatten_design:true () in
  let waves, sim =
    Waveform.create
      (Sim.create
         ~config:Cyclesim.Config.trace_all
         ~name:"day_seven"
         (Day_seven.create scope))
  in
  let sim, oc =
    if create_vcd
    then (
      let oc = Stdlib.Out_channel.open_text "/tmp/day_seven.vcd" in
      let sim = Vcd.wrap oc sim in
      sim, Some oc)
    else sim, None
  in
  let outputs = Cyclesim.outputs sim in
  let inputs = Cyclesim.inputs sim in
  let adjusted_input =
    (input_str
     |> String.split_lines
     |> List.map ~f:String.strip
     |> List.filter ~f:(Fn.non String.is_empty)
     |> List.filteri ~f:(fun i _ -> i % 2 = 0))
    @ [ "X" ]
    |> String.concat ~sep:"\n"
  in
  let cycle_count = ref 0 in
  String.iter adjusted_input ~f:(fun c ->
    let byte = Bits.of_char c in
    inputs.byte_in.valid := Bits.vdd;
    inputs.byte_in.value := byte;
    Cyclesim.cycle sim;
    inputs.byte_in.valid := Bits.gnd;
    Cyclesim.cycle sim ~n:(cycles_per_baud - 1);
    cycle_count := !cycle_count + cycles_per_baud);
  while not (Bits.equal !(outputs.valid) Bits.vdd) do
    Cyclesim.cycle sim;
    Int.incr cycle_count
  done;
  Cyclesim.cycle sim;
  Int.incr cycle_count;
  let byte_in_format =
    Wave_format.Custom
      (fun bits ->
        match Bits.to_int_trunc bits |> Char.of_int_exn with
        | '\n' -> "\\n"
        | c when Char.is_print c -> String.make 1 c
        | c -> sprintf "\\x%02x" (Char.to_int c))
  in
  let sm_format =
    let width = Bits.num_bits_to_represent (List.length Day_seven.States.all) in
    Wave_format.Map
      (List.mapi Day_seven.States.all ~f:(fun i state ->
         Bits.of_int_trunc ~width i, Day_seven.States.to_string state))
  in
  let display_rules =
    [ Display_rule.port_name_matches
        ~wave_format:(Bit_or Unsigned_int)
        (Re.Glob.glob ~anchored:true ~expand_braces:true "{col,valid,value*}"
         |> Re.compile)
    ; Display_rule.port_name_is ~wave_format:byte_in_format "byte_in$value"
    ; Display_rule.port_name_is ~wave_format:sm_format "sm"
    ]
  in
  if print_waveform
  then (
    let start_cycle = if pan_to_end then !cycle_count - display_width + 2 else 0 in
    Waveform.print
      ~start_cycle
      ~display_rules
      ~display_width
      ~signals_width:25
      ~wave_width:(-1)
      waves);
  let reference = Day_seven.reference_solution input_str in
  let part_one = Bits.to_unsigned_int !(outputs.value.part_one) in
  let part_two = Bits.to_unsigned_int !(outputs.value.part_two) in
  Option.iter oc ~f:Out_channel.close;

  [%test_eq: int] ~here:[ here ] part_one reference.part_one;
  [%test_eq: int] ~here:[ here ] part_two reference.part_two;
  print_s [%message (part_one : int) (part_two : int)]
;;

let%expect_test "no splitters" =
  test_input {|
...S...
.......
.......
  |};
  [%expect
    {|
    ┌Signals────────────────┐┌Waves──────────────────────────────────────────────────────────┐
    │valid                  ││                                                               │
    │                       ││───────────────────────────────────────────────────────────────│
    │                       ││───────────────────────────────────────────────────────────────│
    │value$part_one         ││ 0                                                             │
    │                       ││───────────────────────────────────────────────────────────────│
    │                       ││─────────────┬─────────────────────────────────────────────────│
    │value$part_two         ││ 0           │1                                                │
    │                       ││─────────────┴─────────────────────────────────────────────────│
    │                       ││─┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │col                    ││ │1  │2  │3  │4  │5  │6  │7  │0  │1  │2  │3  │4  │5  │6  │7  │0│
    │                       ││─┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │                       ││────────────┬───┬───────────┬───┬───────────────────────────┬──│
    │byte_in$value          ││ .          │S  │.          │\n │.                          │\n│
    │                       ││────────────┴───┴───────────┴───┴───────────────────────────┴──│
    │                       ││─────────────────────────────┬─────────────────────────────────│
    │sm                     ││ Beam_start                  │Splitting                        │
    │                       ││─────────────────────────────┴─────────────────────────────────│
    └───────────────────────┘└───────────────────────────────────────────────────────────────┘
    ((part_one 0) (part_two 1))
    |}]
;;

let%expect_test "one splitter" =
  test_input {|
...S...
.......
...^...
.......
  |};
  [%expect
    {|
    ┌Signals────────────────┐┌Waves──────────────────────────────────────────────────────────┐
    │valid                  ││                                                               │
    │                       ││───────────────────────────────────────────────────────────────│
    │                       ││─────────────────────────────────────────────────────────────┬─│
    │value$part_one         ││ 0                                                           │1│
    │                       ││─────────────────────────────────────────────────────────────┴─│
    │                       ││─────────────┬───────────────────────────────────────────────┬─│
    │value$part_two         ││ 0           │1                                              │2│
    │                       ││─────────────┴───────────────────────────────────────────────┴─│
    │                       ││─┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │col                    ││ │1  │2  │3  │4  │5  │6  │7  │0  │1  │2  │3  │4  │5  │6  │7  │0│
    │                       ││─┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │                       ││────────────┬───┬───────────┬───┬───────────┬───┬───────────┬──│
    │byte_in$value          ││ .          │S  │.          │\n │.          │^  │.          │\n│
    │                       ││────────────┴───┴───────────┴───┴───────────┴───┴───────────┴──│
    │                       ││─────────────────────────────┬─────────────────────────────────│
    │sm                     ││ Beam_start                  │Splitting                        │
    │                       ││─────────────────────────────┴─────────────────────────────────│
    └───────────────────────┘└───────────────────────────────────────────────────────────────┘
    ((part_one 1) (part_two 2))
    |}]
;;

let%expect_test "diamond pattern" =
  test_input
    {|
...S...
.......
...^...
.......
..^.^..
.......
...^...
.......
  |}
    ~pan_to_end:true
    ~display_width:120;
  [%expect
    {|
    ┌Signals────────────────┐┌Waves────────────────────────────────────────────────────────────────────────────────────────┐
    │valid                  ││                                                                                             │
    │                       ││─────────────────────────────────────────────────────────────────────────────────────────────│
    │                       ││──────────────────────────────────────────────┬───────────────────────────────┬──────────────│
    │value$part_one         ││ 0                                            │1                              │3             │
    │                       ││──────────────────────────────────────────────┴───────────────────────────────┴──────────────│
    │                       ││──────────────────────────────────────────────┬───────────────────────────────┬──────────────│
    │value$part_two         ││ 1                                            │2                              │4             │
    │                       ││──────────────────────────────────────────────┴───────────────────────────────┴──────────────│
    │                       ││──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬──│
    │col                    ││ 4│5  │6  │7  │0  │1  │2  │3  │4  │5  │6  │7  │0  │1  │2  │3  │4  │5  │6  │7  │0  │1  │2  │3 │
    │                       ││──┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴──│
    │                       ││─┬───────────┬───┬───────────┬───┬───────────┬───┬───────┬───┬───┬───┬───────┬───┬───────────│
    │byte_in$value          ││ │.          │\n │.          │^  │.          │\n │.      │^  │.  │^  │.      │\n │.          │
    │                       ││─┴───────────┴───┴───────────┴───┴───────────┴───┴───────┴───┴───┴───┴───────┴───┴───────────│
    │                       ││──────────────┬──────────────────────────────────────────────────────────────────────────────│
    │sm                     ││ Beam_start   │Splitting                                                                     │
    │                       ││──────────────┴──────────────────────────────────────────────────────────────────────────────│
    └───────────────────────┘└─────────────────────────────────────────────────────────────────────────────────────────────┘
    ((part_one 4) (part_two 6))
    |}]
;;

let%expect_test "partial official input" =
  test_input
    {|
..........................S..........................
.....................................................
..........................^..........................
.....................................................
.........................^.^.........................
.....................................................
........................^...^........................
.....................................................
.......................^.....^.......................
.....................................................
......................^...^...^......................
.....................................................
.....................^.^...^.^.^.....................
.....................................................
....................^.^.......^.^....................
.....................................................
...................^...^...^.^.^.^...................
.....................................................
..................^.^.^...^.......^..................
.....................................................
.................^...^.^.^.^...^.^.^.................
.....................................................
................^.^.^.^...^.......^.^................
.....................................................
...............^.^.^.^.^.^.^.^.^...^.^...............
.....................................................
..............^.....^.^.^.^.^.....^...^..............
.....................................................
.............^.^.....^.^.^.^.^...^.^.^.^.............
.....................................................
............^.^.^.^.^.^.^.^...^...^.....^............
.....................................................
...........^.^.^.^.^.^.^.......^...^.....^...........
.....................................................
..........^.^.^.^...^.^.....^.^.^.^.^...^.^..........
.....................................................
.........^.^.^.^.^.^.^.....^.....^...^.^.^.^.........
.....................................................
........^.^...^.^.......^.^.^.......^...^.^.^........
.....................................................
.......^...^.^...^...^.^.^.^.^...^...^.^.....^.......
.....................................................
......^.....^...^.^.^.....^...^.^...^.......^.^......
.....................................................
.....^.^.^.^.^.^.^.^...^.^.^.^.^.....^.^...^.^.^.....
.....................................................
....^.^...^.^.....^.^.....^...^.^.^.....^.^...^.^....
.....................................................
...^.........^.^.^.^.^.^.^.^...^.^.^.^...........^...
.....................................................
  |}
    ~print_waveform:false;
  [%expect {| ((part_one 192) (part_two 28579)) |}]
;;
